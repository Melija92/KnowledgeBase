@{
    ViewBag.Title = "ASP.NET Applications Using Wait Handles";
}

<h1>ASP.NET Applications Using Wait Handles</h1>
<p>
    The callback and polling models for handling asynchronous operations are useful when your application is processing only one asynchronous operation at a time. The Wait models provide a more flexible way of processing multiple asynchronous operations. There are two Wait models, named for the WaitHandle methods used to implement them: the Wait (Any) model and the Wait (All) model.
    <br />
    <br />
    To use either Wait model, you need to use the AsyncWaitHandle property of the IAsyncResult object returned by the BeginExecuteNonQuery, BeginExecuteReader, or BeginExecuteXmlReader methods. The WaitAny and WaitAll methods both require you to send the WaitHandle objects as an argument, grouped together in an array.
    <br />
    <br />

    Both Wait methods monitor the asynchronous operations, waiting for completion. The WaitAny method waits for any of the operations to complete or time out. Once you know a particular operation is complete, you can process its results and then continue waiting for the next operation to complete or time out. The WaitAll method waits for all of the processes in the array of WaitHandle instances to complete or time out before continuing.
    <br />
    <br />

    Following is the example for handling asynchronous operations.
</p>
<pre>
    <span style='color:#800000; font-weight:bold; '>private</span> <span style='color:#800000; font-weight:bold; '>string</span> GetConnectionString<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>  
    <span style='color:#800080; '>{</span>  
        <span style='color:#800000; font-weight:bold; '>return</span> ConfigurationManager<span style='color:#808030; '>.</span>ConnectionStrings<span style='color:#808030; '>[</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>ConnectionString</span><span style='color:#800000; '>"</span><span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>ConnectionString<span style='color:#800080; '>;</span>  
    <span style='color:#800080; '>}</span>
</pre>
<pre>
    SqlConnection con_1 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>new</span> SqlConnection<span style='color:#808030; '>(</span>GetConnectionString<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    SqlConnection con_2 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>new</span> SqlConnection<span style='color:#808030; '>(</span>GetConnectionString<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    SqlConnection con_3 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>new</span> SqlConnection<span style='color:#808030; '>(</span>GetConnectionString<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <br />
    <span style='color:#800000; font-weight:bold; '>try</span>
        <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>string</span> commandText1 <span style='color:#808030; '>=</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>WAITFOR DELAY '0:0:01'; SELECT * FROM T_Employees WHERE ID = 15</span><span style='color:#800000; '>"</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>string</span> commandText2 <span style='color:#808030; '>=</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>WAITFOR DELAY '0:0:15'; SELECT * FROM T_Employees WHERE ID = 15</span><span style='color:#800000; '>"</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>string</span> commandText3 <span style='color:#808030; '>=</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>WAITFOR DELAY '0:0:25'; SELECT * FROM T_Employees WHERE ID = 15</span><span style='color:#800000; '>"</span><span style='color:#800080; '>;</span>
        WaitHandle<span style='color:#808030; '>[</span><span style='color:#808030; '>]</span> waitHandles <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>new</span> WaitHandle<span style='color:#808030; '>[</span><span style='color:#808030; '>]</span>
        <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>new</span> AutoResetEvent<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>true</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
        <span style='color:#800000; font-weight:bold; '>new</span> AutoResetEvent<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>true</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
        <span style='color:#800000; font-weight:bold; '>new</span> AutoResetEvent<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>true</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
        <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
            con_1<span style='color:#808030; '>.</span>Open<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            SqlCommand cmd1 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>new</span> SqlCommand<span style='color:#808030; '>(</span>commandText1<span style='color:#808030; '>,</span> con_1<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            IAsyncResult result1 <span style='color:#808030; '>=</span> cmd1<span style='color:#808030; '>.</span>BeginExecuteReader<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            waitHandles<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> result1<span style='color:#808030; '>.</span>AsyncWaitHandle<span style='color:#800080; '>;</span>
            con_2<span style='color:#808030; '>.</span>Open<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            SqlCommand cmd2 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>new</span> SqlCommand<span style='color:#808030; '>(</span>commandText2<span style='color:#808030; '>,</span> con_2<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            IAsyncResult result2 <span style='color:#808030; '>=</span> cmd2<span style='color:#808030; '>.</span>BeginExecuteReader<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            waitHandles<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> result2<span style='color:#808030; '>.</span>AsyncWaitHandle<span style='color:#800080; '>;</span>
            con_3<span style='color:#808030; '>.</span>Open<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            SqlCommand cmd3 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>new</span> SqlCommand<span style='color:#808030; '>(</span>commandText3<span style='color:#808030; '>,</span> con_3<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            IAsyncResult result3 <span style='color:#808030; '>=</span> cmd3<span style='color:#808030; '>.</span>BeginExecuteReader<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            waitHandles<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> result3<span style='color:#808030; '>.</span>AsyncWaitHandle<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>int</span> index <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>3</span><span style='color:#800080; '>;</span> i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
        <span style='color:#800080; '>{</span>
            index <span style='color:#808030; '>=</span> WaitHandle<span style='color:#808030; '>.</span>WaitAny<span style='color:#808030; '>(</span>waitHandles<span style='color:#808030; '>,</span> <span style='color:#008c00; '>60000</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>false</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>switch</span> <span style='color:#808030; '>(</span>index<span style='color:#808030; '>)</span>
            <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>case</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>:</span>
                SqlDataReader reader1 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>default</span><span style='color:#808030; '>(</span>SqlDataReader<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#808030; '>reader1 =</span> cmd1<span style='color:#808030; '>.</span>EndExecuteReader<span style='color:#808030; '>(</span>result1<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>reader1<span style='color:#808030; '>.</span>Read<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
                <span style='color:#800080; '>{</span>
                 Span1<span style='color:#808030; '>.</span>InnerHtml <span style='color:#808030; '>=</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Task </span><span style='color:#800000; '>"</span> <span style='color:#808030; '>+</span> i <span style='color:#808030; '>+</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '> Completed </span><span style='color:#800000; '>"</span> <span style='color:#808030; '>+</span> System<span style='color:#808030; '>.</span>DateTime<span style='color:#808030; '>.</span>Now<span style='color:#808030; '>.</span>ToLongTimeString<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
                reader1<span style='color:#808030; '>.</span>Close<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>case</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>:</span>
                SqlDataReader reader2 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>default</span><span style='color:#808030; '>(</span>SqlDataReader<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                reader2 <span style='color:#808030; '>=</span> cmd2<span style='color:#808030; '>.</span>EndExecuteReader<span style='color:#808030; '>(</span>result2<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>reader2<span style='color:#808030; '>.</span>Read<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
                <span style='color:#800080; '>{</span>
                Span2<span style='color:#808030; '>.</span>InnerHtml <span style='color:#808030; '>=</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Task </span><span style='color:#800000; '>"</span> <span style='color:#808030; '>+</span> i <span style='color:#808030; '>+</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '> Completed </span><span style='color:#800000; '>"</span> <span style='color:#808030; '>+</span> System<span style='color:#808030; '>.</span>DateTime<span style='color:#808030; '>.</span>Now<span style='color:#808030; '>.</span>ToLongTimeString<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
                reader2<span style='color:#808030; '>.</span>Close<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>case</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>:</span>
                SqlDataReader reader3 <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>default</span><span style='color:#808030; '>(</span>SqlDataReader<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                reader3 <span style='color:#808030; '>=</span> cmd3<span style='color:#808030; '>.</span>EndExecuteReader<span style='color:#808030; '>(</span>result3<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>reader3<span style='color:#808030; '>.</span>Read<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
                <span style='color:#800080; '>{</span>
                Span3<span style='color:#808030; '>.</span>InnerHtml <span style='color:#808030; '>=</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Task </span><span style='color:#800000; '>"</span> <span style='color:#808030; '>+</span> i <span style='color:#808030; '>+</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '> Completed </span><span style='color:#800000; '>"</span> <span style='color:#808030; '>+</span> System<span style='color:#808030; '>.</span>DateTime<span style='color:#808030; '>.</span>Now<span style='color:#808030; '>.</span>ToLongTimeString<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
                reader3<span style='color:#808030; '>.</span>Close<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>case</span> WaitHandle<span style='color:#808030; '>.</span>WaitTimeout<span style='color:#808030; '>:</span>
                <span style='color:#800000; font-weight:bold; '>throw</span> <span style='color:#800000; font-weight:bold; '>new</span> Exception<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Timeout</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>index <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> WaitHandle<span style='color:#808030; '>.</span>WaitTimeout<span style='color:#808030; '>)</span>
        <span style='color:#800080; '>{</span>
        result<span style='color:#808030; '>.</span>InnerHtml <span style='color:#808030; '>=</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Timeout</span><span style='color:#800000; '>"</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>catch</span> <span style='color:#808030; '>(</span>Exception ex<span style='color:#808030; '>)</span>
    <span style='color:#800080; '>{</span>
        result<span style='color:#808030; '>.</span>InnerHtml <span style='color:#808030; '>=</span> ex<span style='color:#808030; '>.</span>Message<span style='color:#808030; '>.</span>ToString<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>finally</span>
    <span style='color:#800080; '>{</span>
        con_1<span style='color:#808030; '>.</span>Close<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        con_2<span style='color:#808030; '>.</span>Close<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        con_3<span style='color:#808030; '>.</span>Close<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
</pre>
<p>ThreadPool.QueueUserWorkItem - Queues a method for execution. The method executes when a thread pool thread becomes available. <br /><br />
AutoResetEvent - The AutoResetEvent class represents a local wait handle event that resets automatically when signaled, after releasing a single waiting thread.</p>
